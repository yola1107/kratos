<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket 登录 (protobuf)</title>
  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.3/dist/protobuf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin-top: 8px; }
    input { width: 200px; padding: 4px; }
    button { margin-top: 10px; padding: 6px 12px; }
    #log {
      margin-top: 15px;
      width: 100%;
      height: 200px;
      border: 1px solid #ccc;
      overflow-y: auto;
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 8px;
    }
  </style>
</head>
<body>

<h2>WebSocket 登录测试器 (protobuf)</h2>

<label>用户ID:</label>
<input type="number" id="userID" value="123456" />
<label>Token:</label>
<input type="text" id="token" value="abc123" />
<label>类型:</label>
<input type="number" id="type" value="1" />
<label>桌号:</label>
<input type="number" id="tableID" value="0" />
<label>椅子号:</label>
<input type="number" id="chairID" value="0" />
<br />
<button id="connectBtn">连接 WebSocket</button>

<div id="log"></div>

<script>
  const protoStr = `
    syntax = "proto3";
    package websocket.proto;

    message Payload {
      int32 op      = 1;
      int32 place   = 2;
      int32 seq     = 3;
      int32 code    = 4;
      int32 command = 5;
      bytes body    = 6;
    }

    message LoginReq {
      int64 userID  = 1;
      string token  = 2;
      int32 type    = 3;
      int32 tableID = 4;
      int32 chairID = 5;
    }
  `;

  let root = null;
  let Payload = null;
  let LoginReq = null;
  let socket = null;
  let seq = 1;
  let heartbeatInterval = null;
  const logDiv = document.getElementById('log');

  function log(msg) {
    logDiv.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function loadProto() {
    const parsed = protobuf.parse(protoStr);
    root = parsed.root;
    Payload = root.lookupType("websocket.proto.Payload");
    LoginReq = root.lookupType("websocket.proto.LoginReq");
    log("Proto 加载完成");
  }

  function createPayload(op, command, bodyBytes = null) {
    const payload = Payload.create({
      op: op,
      place: 0,
      seq: seq++,
      code: 0,
      command: command,
      body: bodyBytes || new Uint8Array(0)
    });
    return Payload.encode(payload).finish();
  }

  function sendPing() {
    if (socket && socket.readyState === WebSocket.OPEN) {
      const pingPayload = createPayload(1, 0);
      socket.send(pingPayload);
      log("发送 Ping (op=1, command=0)");
      
      // 发送登录请求
      sendLoginRequest();
    }
  }

  function sendLoginRequest() {
    const userID = BigInt(document.getElementById('userID').value);
    const token = document.getElementById('token').value;
    const type = parseInt(document.getElementById('type').value);
    const tableID = parseInt(document.getElementById('tableID').value);
    const chairID = parseInt(document.getElementById('chairID').value);

    const loginPayload = LoginReq.create({
      userID, token, type, tableID, chairID
    });
    const loginBytes = LoginReq.encode(loginPayload).finish();
    const fullPayload = createPayload(3, 1001, loginBytes);  // op=3, command=1001

    socket.send(fullPayload);
    log("发送 LoginReq (op=3, command=1001)");
  }

  document.getElementById('connectBtn').onclick = function () {
    if (socket && socket.readyState === WebSocket.OPEN) {
      log("已连接，无需重复连接");
      return;
    }

    socket = new WebSocket("ws://localhost:3102");
    socket.binaryType = "arraybuffer";

    socket.onopen = () => {
      log("WebSocket 已连接");
      heartbeatInterval = setInterval(sendPing, 10000); // 每10秒发送一次ping
    };

    socket.onmessage = (event) => {
      const bytes = new Uint8Array(event.data);
      log(`收到消息 (${bytes.length} bytes)`);
    };

    socket.onclose = () => {
      log("WebSocket 已关闭");
      clearInterval(heartbeatInterval);
    };

    socket.onerror = (err) => {
      log("WebSocket 错误: " + err.message);
    };
  };

  loadProto();
</script>

</body>
</html>
